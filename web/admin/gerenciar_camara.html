<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerenciar C√¢mara - Legisla Net</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../css/global.css" />
    <link rel="stylesheet" href="../css/forms.css" />
    <link rel="stylesheet" href="../css/modals.css" />
    <link rel="stylesheet" href="../css/admin.css" />
    <link rel="stylesheet" href="../css/customSelect.css" />
    <link rel="stylesheet" href="../css/toast.css" />
    <link rel="stylesheet" href="../css/carregamento.css" />

    <style>
      .main-content {
        position: relative;
      }
      .background-logo-container {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 50%;
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
        opacity: 0.05;
        pointer-events: none;
        z-index: 0;
      }
      .form-section {
        position: relative;
        z-index: 1;
      }
      .tabs-nav {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 32px;
        overflow-x: auto;
        gap: 4px;
      }
      .tab-item {
        padding: 12px 20px;
        cursor: pointer;
        background: none;
        border: none;
        color: var(--secondary-text);
        font-weight: 500;
        font-size: 1rem;
        position: relative;
        border-bottom: 2px solid transparent;
        transition: color 0.2s, border-color 0.2s;
        white-space: nowrap;
      }
      .tab-item:hover {
        color: var(--primary-text);
      }
      .tab-item.active {
        color: var(--accent-blue);
        border-bottom-color: var(--accent-blue);
      }
      .tab-pane {
        display: none;
      }
      .tab-pane.active {
        display: block;
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .management-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }
      .management-header h3 {
        font-size: 1.5rem;
      }
      .item-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 24px;
      }
      .item-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        transition: all 0.2s ease-in-out;
      }
      .item-card:hover {
        border-color: var(--accent-blue);
        transform: translateY(-4px);
      }
      .item-card-header {
        display: flex;
        align-items: center;
        gap: 16px;
        padding-bottom: 16px;
        margin-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
      }
      .item-card-logo,
      .item-card-avatar {
        width: 50px;
        height: 50px;
        object-fit: cover;
        flex-shrink: 0;
      }
      .item-card-logo {
        object-fit: contain;
        background-color: #fff;
        border-radius: 8px;
        padding: 5px;
      }
      .item-card-avatar {
        border-radius: 50%;
      }
      .item-card-info h4 {
        font-size: 1.1rem;
      }
      .item-card-info p {
        color: var(--secondary-text);
        font-size: 0.9rem;
      }
      .item-card-body {
        flex-grow: 1;
      }
      .item-card-footer {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        padding-top: 16px;
        margin-top: auto;
      }
      .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
      }
      .file-input-wrapper input[type="file"] {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
        z-index: 10;
      }
      .partido-select-container {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      #partido-logo-preview {
        width: 40px;
        height: 40px;
        object-fit: contain;
        background-color: #fff;
        border-radius: 6px;
        padding: 4px;
        border: 1px solid var(--border-color);
        visibility: hidden;
        transition: visibility 0.2s;
      }
      #partido-logo-preview.visible {
        visibility: visible;
      }
      /* Estilos antigos dos status-badge removidos - agora padronizados acima */

      /* Container para flags lado a lado */
      .flags-container {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      /* Estilos padronizados para todos os flags */
      .status-badge,
      .cargo-flag {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 99px;
        font-weight: 500;
        font-size: 0.7rem;
        text-align: center;
        white-space: nowrap;
        text-transform: uppercase;
      }

      /* Cores dos flags de status */
      .status-badge.status-active {
        background-color: rgba(46, 160, 67, 0.2);
        color: #71e67f;
        border: 1px solid rgba(46, 160, 67, 0.4);
      }
      .status-badge.status-inactive {
        background-color: rgba(218, 54, 51, 0.2);
        color: #f85149;
        border: 1px solid rgba(218, 54, 51, 0.4);
      }

      /* Cores dos flags de cargo */
      .cargo-flag.presidente {
        background-color: rgba(255, 159, 10, 0.2);
        color: #ff9f0a;
        border: 1px solid rgba(255, 159, 10, 0.4);
      }
      .cargo-flag.vice-presidente {
        background-color: rgba(138, 43, 226, 0.2);
        color: #9d4edd;
        border: 1px solid rgba(138, 43, 226, 0.4);
      }
      .form-section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary-text);
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
      }
      .partido-logo-card {
        width: 30px;
        height: 30px;
        object-fit: contain;
        background-color: #fff;
        border-radius: 4px;
        padding: 2px;
        border: 1px solid var(--border-color);
      }
      .form-select {
        background-color: var(--hover-bg) !important;
        border: 1px solid var(--border-color) !important;
        color: var(--primary-text) !important;
      }
      .toggle-group-modal {
        display: flex;
        gap: 24px;
        align-items: center;
        margin-top: 8px;
      }
      .toggle-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }
    </style>
  </head>
  <body>
    <div class="app-layout">
      <div id="sidebar-placeholder"></div>
      <main class="main-content" id="mainContent">
        <div id="header-placeholder"></div>
        <div class="background-logo-container"></div>

        <section class="form-section fade-in">
          <div class="tabs-nav">
            <button class="tab-item active" data-tab="info">
              Informa√ß√µes Gerais e Admin
            </button>
            <button class="tab-item" data-tab="vereadores">Vereadores</button>
            <button class="tab-item" data-tab="midias">M√≠dias Sociais</button>
          </div>

          <div class="tabs-content">
            <div class="tab-pane active" id="info">
              <form id="form-info-gerais">
                <input type="hidden" id="adminUserId" />
                <h3 class="form-section-title">Dados da C√¢mara</h3>
                <div class="form-group toggle-group">
                  <label class="toggle-switch"
                    ><input type="checkbox" id="camara-is_active" /><span
                      class="slider"
                    ></span></label
                  ><span>Status da C√¢mara (Ativa / Inativa)</span>
                </div>
                <div class="form-group">
                  <label for="nome_camara">Nome da C√¢mara</label
                  ><input type="text" id="nome_camara" class="form-input" />
                </div>
                <div class="form-group">
                  <label for="municipio">Munic√≠pio</label
                  ><input type="text" id="municipio" class="form-input" />
                </div>
                <div class="form-group">
                  <label for="estado">Estado</label
                  ><select id="estado" class="form-select"></select>
                </div>
                <div class="form-group">
                  <label>Bras√£o / Logo da C√¢mara</label>
                  <img
                    src=""
                    alt="Logo atual"
                    id="brasao-preview"
                    class="item-card-logo"
                    style="
                      width: 80px;
                      height: 80px;
                      margin-bottom: 16px;
                      display: none;
                    "
                  />
                  <div class="file-input-wrapper">
                    <label for="brasao_url" class="file-input-button"
                      >Alterar...</label
                    >
                    <span id="file-name" class="file-input-text"
                      >Nenhum novo arquivo selecionado.</span
                    >
                    <input type="file" id="brasao_url" />
                  </div>
                </div>

                <h3 class="form-section-title" style="margin-top: 32px">
                  Credenciais do Administrador da C√¢mara
                </h3>
                <div class="form-group">
                  <label for="admin_email"
                    >Email de Acesso do Administrador</label
                  ><input
                    type="email"
                    id="admin_email"
                    class="form-input"
                    disabled
                  />
                </div>
                <div class="form-group">
                  <label for="admin_senha">Nova Senha do Administrador</label
                  ><input
                    type="password"
                    id="admin_senha"
                    class="form-input"
                    placeholder="Deixe em branco para n√£o alterar"
                  />
                </div>

                <h3 class="form-section-title" style="margin-top: 24px">
                  Credenciais da TV (opcional)
                </h3>
                <div class="form-group">
                  <label for="tv_email">Email de Acesso da TV</label
                  ><input
                    type="email"
                    id="tv_email"
                    class="form-input"
                    placeholder="tv@camara.example.com"
                  />
                </div>
                <div class="form-group">
                  <label for="tv_senha">Senha da TV</label
                  ><input
                    type="password"
                    id="tv_senha"
                    class="form-input"
                    placeholder="Deixe em branco para n√£o alterar/criar"
                  />
                </div>

                <div class="form-actions">
                  <button type="submit" class="btn btn-primary">
                    Salvar Altera√ß√µes
                  </button>
                </div>
              </form>
            </div>

            <div class="tab-pane" id="vereadores">
              <div class="management-header">
                <h3>Vereadores</h3>
                <button id="add-vereador-btn" class="btn btn-primary">
                  <i class="fa fa-plus"></i> Adicionar Vereador
                </button>
              </div>
              <div class="item-grid" id="vereadores-grid"></div>
            </div>

            <div class="tab-pane" id="midias">
              <form id="form-midias-sociais">
                <h3 class="form-section-title">Links e M√≠dias Sociais</h3>
                <div class="form-group">
                  <label for="link_facebook">Link do Facebook</label>
                  <input
                    type="url"
                    id="link_facebook"
                    placeholder="https://facebook.com/..."
                    value=""
                  />
                </div>
                <div class="form-group">
                  <label for="link_instagram">Link do Instagram</label>
                  <input
                    type="url"
                    id="link_instagram"
                    placeholder="https://instagram.com/..."
                    value=""
                  />
                </div>
                <div class="form-group">
                  <label for="link_youtube">Link do YouTube</label>
                  <input
                    type="url"
                    id="link_youtube"
                    placeholder="https://youtube.com/..."
                    value=""
                  />
                </div>
                <div class="form-group">
                  <label for="site_oficial">Site Oficial</label>
                  <input
                    type="url"
                    id="site_oficial"
                    placeholder="https://..."
                    value=""
                  />
                </div>
                <div class="form-group">
                  <label for="youtube_stream_key"
                    >Chave de Transmiss√£o do YouTube</label
                  >
                  <input
                    type="text"
                    id="youtube_stream_key"
                    placeholder="Chave de stream do YouTube para transmiss√µes ao vivo"
                    value=""
                  />
                </div>
                <div class="form-group">
                  <label for="youtube_rtmp_url"
                    >URL do Servidor RTMP do YouTube</label
                  >
                  <input
                    type="url"
                    id="youtube_rtmp_url"
                    placeholder="rtmp://a.rtmp.youtube.com/live2"
                    value=""
                  />
                </div>
                <div class="form-group">
                  <label for="youtube_channel_id">ID do Canal do YouTube</label>
                  <input
                    type="text"
                    id="youtube_channel_id"
                    placeholder="UC_x5XG1OV2P6uZZ5FSM9Ttw"
                    value=""
                  />
                </div>
                <div class="form-group">
                  <label for="youtube_channel_url"
                    >URL do Canal do YouTube</label
                  >
                  <input
                    type="url"
                    id="youtube_channel_url"
                    placeholder="https://www.youtube.com/@suacanal"
                    value=""
                  />
                </div>
                <div class="form-actions">
                  <button type="submit" class="btn btn-primary">
                    Salvar Links
                  </button>
                </div>
              </form>
            </div>
          </div>
        </section>
      </main>
    </div>

    <div class="modal-overlay" id="vereadorModal">
      <div class="modal-container">
        <div class="modal-header">
          <h3 class="modal-title" id="vereadorModalTitle">
            Adicionar Vereador
          </h3>
          <button class="modal-close" id="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
          <form id="vereadorForm">
            <input type="hidden" id="vereadorId" />
            <div class="form-group">
              <label for="nome_parlamentar" data-required="true"
                >Nome Parlamentar</label
              ><input
                type="text"
                id="nome_parlamentar"
                class="form-input"
                data-validate
                required
              /><span class="form-error"></span>
            </div>
            <div class="form-group">
              <label for="vereador_email" data-required="true"
                >Email de Acesso</label
              ><input
                type="email"
                id="vereador_email"
                name="vereador_email"
                class="form-input"
                placeholder="Digite o email do vereador"
                data-validate
                required
              /><span class="form-error"></span>
            </div>
            <div class="form-group">
              <label for="vereador_senha" data-required="true"
                >Senha de Acesso</label
              ><input
                type="password"
                id="vereador_senha"
                name="vereador_senha"
                class="form-input"
                placeholder="Digite a senha (m√≠nimo 8 caracteres)"
                data-validate
              /><span class="form-error"></span>
            </div>
            <div class="form-group">
              <label for="partido_id" data-required="true">Partido</label>
              <div class="custom-select-wrapper" id="partido-custom-select">
                <input
                  type="hidden"
                  id="partido_id"
                  name="partido_id"
                  required
                />
                <div class="custom-select-trigger">
                  <span>Selecione um partido...</span>
                </div>
                <div class="custom-options"></div>
              </div>
            </div>
            <div class="form-group">
              <label>Cargos</label>
              <div class="toggle-group-modal">
                <div class="toggle-item">
                  <label class="toggle-switch">
                    <input type="checkbox" id="is_presidente" />
                    <span class="slider"></span>
                  </label>
                  <span>Presidente</span>
                </div>
                <div class="toggle-item">
                  <label class="toggle-switch">
                    <input type="checkbox" id="is_vice_presidente" />
                    <span class="slider"></span>
                  </label>
                  <span>Vice-Presidente</span>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label data-required="true">Foto do Vereador</label
              ><input
                type="file"
                id="foto_url_vereador"
                class="form-input"
                accept="image/*"
                data-validate
                required
              /><span class="form-error"></span>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="modal-cancel-btn">
            Cancelar
          </button>
          <button type="submit" form="vereadorForm" class="btn btn-primary">
            Salvar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de confirma√ß√£o de troca de cargo -->
    <div class="modal-overlay" id="cargoConfirmModal">
      <div class="modal-container">
        <div class="modal-header">
          <h3 class="modal-title">Transferir Cargo</h3>
          <button class="modal-close" id="cargo-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div
            style="
              display: flex;
              align-items: center;
              gap: 12px;
              margin-bottom: 16px;
            "
          >
            <i
              class="fa-solid fa-triangle-exclamation"
              style="color: var(--accent-orange); font-size: 1.5rem"
            ></i>
            <div>
              <h4 style="margin: 0; color: var(--primary-text)">
                Confirma√ß√£o Necess√°ria
              </h4>
              <p style="margin: 4px 0 0 0; color: var(--secondary-text)">
                Esta a√ß√£o ir√° alterar a estrutura de cargos da c√¢mara.
              </p>
            </div>
          </div>
          <div
            style="
              background-color: var(--hover-bg);
              padding: 16px;
              border-radius: 8px;
              border-left: 4px solid var(--accent-orange);
            "
          >
            <p
              id="cargo-message"
              style="margin: 0; color: var(--primary-text)"
            ></p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="cargo-cancel-btn">
            Cancelar
          </button>
          <button type="button" class="btn btn-primary" id="cargo-confirm-btn">
            Confirmar Transfer√™ncia
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de confirma√ß√£o de exclus√£o de vereador -->
    <div class="modal-overlay" id="deleteVereadorModal">
      <div class="modal-container">
        <div class="modal-header">
          <h3 class="modal-title">Confirmar Exclus√£o</h3>
          <button class="modal-close" id="delete-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div
            style="
              display: flex;
              align-items: center;
              gap: 12px;
              margin-bottom: 16px;
            "
          >
            <i
              class="fa-solid fa-triangle-exclamation"
              style="color: var(--accent-red); font-size: 1.5rem"
            ></i>
            <div>
              <h4 style="margin: 0; color: var(--primary-text)">
                A√ß√£o Irrevers√≠vel
              </h4>
              <p style="margin: 4px 0 0 0; color: var(--secondary-text)">
                Esta a√ß√£o n√£o pode ser desfeita.
              </p>
            </div>
          </div>
          <div
            style="
              background-color: var(--hover-bg);
              padding: 16px;
              border-radius: 8px;
              border-left: 4px solid var(--accent-red);
            "
          >
            <p
              id="delete-message"
              style="margin: 0; color: var(--primary-text)"
            ></p>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            id="delete-cancel-btn"
          >
            Cancelar
          </button>
          <button
            type="button"
            class="btn btn-primary"
            id="delete-confirm-btn"
            style="background-color: var(--accent-red)"
          >
            Confirmar Exclus√£o
          </button>
        </div>
      </div>
    </div>

    <script src="../js/formValidator.js"></script>
    <script src="../js/global.js"></script>
    <script src="../js/forms.js"></script>
    <script src="../js/modals.js"></script>
    <script src="../js/customSelect.js"></script>
    <script src="../js/toast.js"></script>
    <script src="../js/carregamento.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const authToken = localStorage.getItem("authToken");
        if (!authToken) {
          window.location.href = "/app/login.html";
          return;
        }

        const camaraId = new URLSearchParams(window.location.search).get("id");
        if (!camaraId) {
          document.getElementById("mainContent").innerHTML =
            "<h1>Erro: ID da C√¢mara n√£o fornecido na URL.</h1>";
          return;
        }

        await initLayout({ title: "Carregando...", icon: "fa-sliders" });

        setupTabs();
        setupModalEvents();
        setupValidationForModal(); // <-- CHAMADA DA NOVA FUN√á√ÉO
        await initPartidoCustomSelect(authToken);

        await loadCamaraData(camaraId, authToken);
        await loadVereadores(camaraId, authToken);

        document
          .getElementById("form-info-gerais")
          .addEventListener("submit", (e) =>
            handleUpdateCamara(e, camaraId, authToken)
          );
        document
          .getElementById("form-midias-sociais")
          .addEventListener("submit", (e) =>
            handleUpdateCamara(e, camaraId, authToken)
          );
        document
          .getElementById("add-vereador-btn")
          .addEventListener("click", () => openAddVereadorModal());
        document
          .getElementById("vereadorForm")
          .addEventListener("submit", (e) =>
            handleVereadorFormSubmit(e, camaraId, authToken)
          );
        document
          .getElementById("brasao_url")
          .addEventListener("change", updateBrasaoPreview);
        // Configurar event listeners para garantir que apenas um cargo seja selecionado
        setupCargoToggleLogic();
        console.log(
          "Event listeners configurados para cargos mutuamente exclusivos"
        );

        // Configurar valida√ß√£o em tempo real ap√≥s carregar a p√°gina
        setupRealTimeValidation();
      });

      // FUN√á√ÉO PARA DEFINIR REGRAS DE VALIDA√á√ÉO COMPLETAS
      function setupValidationForModal() {
        if (typeof formValidator === "undefined") {
          console.error("formValidator.js n√£o foi carregado.");
          return;
        }

        // Define as regras para todos os campos do modal
        formValidator
          .setRules("nome_parlamentar", {
            required: true,
            nomeParlamentar: true,
            minLength: 2,
            maxLength: 100,
          })
          .setRules("vereador_email", {
            required: true,
            email: true,
            maxLength: 255,
          })
          .setRules("vereador_senha", {
            required: true,
            strongPassword: true,
            minLength: 8,
            maxLength: 128,
          })
          .setRules("partido_id", {
            required: true,
            custom: (value) => (!value ? "Selecione um partido" : null),
          })
          .setRules("foto_url_vereador", {
            required: true,
            custom: (value, element) => {
              const isEditing = !!document.getElementById("vereadorId").value;
              if (
                !isEditing &&
                (!element.files || element.files.length === 0)
              ) {
                return "Selecione uma foto para o vereador";
              }
              return null;
            },
          });

        // Configurar valida√ß√£o em tempo real para todos os campos
        setupRealTimeValidation();
      }

      function setupTabs() {
        const tabs = document.querySelectorAll(".tab-item");
        const panes = document.querySelectorAll(".tab-pane");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            tabs.forEach((item) => item.classList.remove("active"));
            panes.forEach((pane) => pane.classList.remove("active"));
            tab.classList.add("active");
            document.getElementById(tab.dataset.tab).classList.add("active");
          });
        });
      }

      function setupModalEvents() {
        const closeBtn = document.getElementById("modal-close-btn");
        const cancelBtn = document.getElementById("modal-cancel-btn");

        closeBtn.addEventListener("click", () => {
          closeModal("vereadorModal");
        });
        cancelBtn.addEventListener("click", () => {
          closeModal("vereadorModal");
        });
      }

      // Vari√°vel global para armazenar os vereadores
      let currentVereadores = [];

      // Fun√ß√£o para configurar l√≥gica de cargos mutuamente exclusivos
      function setupCargoToggleLogic() {
        const presidenteCheckbox = document.getElementById("is_presidente");
        const viceCheckbox = document.getElementById("is_vice_presidente");

        if (presidenteCheckbox && viceCheckbox) {
          presidenteCheckbox.addEventListener("change", function () {
            if (this.checked) {
              viceCheckbox.checked = false;
              console.log(
                "üëë Cargo Presidente selecionado - Vice-Presidente desmarcado"
              );
            }
          });

          viceCheckbox.addEventListener("change", function () {
            if (this.checked) {
              presidenteCheckbox.checked = false;
              console.log(
                "ü§µ Cargo Vice-Presidente selecionado - Presidente desmarcado"
              );
            }
          });

          console.log(
            "‚öôÔ∏è Event listeners configurados para cargos mutuamente exclusivos"
          );
        } else {
          console.warn("‚ö†Ô∏è N√£o foi poss√≠vel encontrar os checkboxes de cargo");
        }
      }

      // Fun√ß√£o para configurar valida√ß√£o em tempo real
      function setupRealTimeValidation() {
        const fields = [
          { id: "nome_parlamentar", name: "nome_parlamentar" },
          { id: "vereador_email", name: "vereador_email" },
          { id: "vereador_senha", name: "vereador_senha" },
          { id: "partido_id", name: "partido_id" },
          { id: "foto_url_vereador", name: "foto_url_vereador" },
        ];

        fields.forEach((field) => {
          const element = document.getElementById(field.id);
          if (element) {
            const eventType =
              field.id === "foto_url_vereador" ? "change" : "blur";

            element.addEventListener(eventType, function () {
              if (typeof formValidator !== "undefined") {
                formValidator.validateField(field.name, this.value || this);
              }
            });

            // Tamb√©m validar em tempo real durante digita√ß√£o (exceto arquivo)
            if (field.id !== "foto_url_vereador") {
              element.addEventListener("input", function () {
                if (typeof formValidator !== "undefined") {
                  // Pequeno delay para n√£o validar a cada tecla
                  clearTimeout(this.validationTimeout);
                  this.validationTimeout = setTimeout(() => {
                    formValidator.validateField(field.name, this.value);
                  }, 500);
                }
              });
            }
          }
        });

        console.log("‚úÖ Valida√ß√£o em tempo real configurada");
      }

      async function validateCargoUnico() {
        console.log("üîç validateCargoUnico() chamada");
        const presidenteCheckbox = document.getElementById("is_presidente");
        const viceCheckbox = document.getElementById("is_vice_presidente");
        const currentVereadorId = document.getElementById("vereadorId").value;

        console.log("Estado atual:", {
          presidente: presidenteCheckbox?.checked,
          vice: viceCheckbox?.checked,
          currentId: currentVereadorId,
          totalVereadores: currentVereadores.length,
        });

        // N√£o √© necess√°rio verificar conflitos internos - j√° garantidos pelos event listeners

        // Se nenhum cargo foi selecionado, n√£o h√° o que validar
        if (!presidenteCheckbox.checked && !viceCheckbox.checked) {
          window.cargoParaTransferir = null;
          return true; // Retorna true para indicar valida√ß√£o OK
        }

        let cargoSelecionado = "";
        let cargoAtual = "";

        if (presidenteCheckbox.checked) {
          cargoSelecionado = "presidente";
          cargoAtual = "Presidente";
        }

        if (viceCheckbox.checked) {
          cargoSelecionado = "vice_presidente";
          cargoAtual = "Vice-Presidente";
        }

        // Procurar se j√° existe algu√©m com este cargo
        console.log("üîç Procurando vereador com cargo:", cargoSelecionado);
        console.log(
          "üîç Lista de vereadores:",
          currentVereadores.map((v) => ({
            id: v.id,
            nome: v.nome_parlamentar,
            is_presidente: v.is_presidente,
            is_vice_presidente: v.is_vice_presidente,
          }))
        );

        const vereadorComCargo = currentVereadores.find((v) => {
          const temCargo =
            v[`is_${cargoSelecionado}`] &&
            v.id.toString() !== currentVereadorId;
          console.log(
            `üîç Vereador ${v.nome_parlamentar}: tem cargo ${cargoSelecionado}?`,
            v[`is_${cargoSelecionado}`],
            "ID diferente?",
            v.id.toString() !== currentVereadorId,
            "Resultado:",
            temCargo
          );
          return temCargo;
        });

        console.log("üîç Vereador com cargo encontrado:", vereadorComCargo);

        if (vereadorComCargo) {
          console.log("‚ö†Ô∏è CONFLITO DETECTADO! Mostrando modal...");
          // Mostrar modal de confirma√ß√£o
          const message = `O vereador "${vereadorComCargo.nome_parlamentar}" j√° ocupa o cargo de ${cargoAtual}. Deseja transferir este cargo para o vereador atual? O cargo ser√° removido de "${vereadorComCargo.nome_parlamentar}".`;

          return new Promise((resolve) => {
            showCargoConfirmModal(
              message,
              cargoSelecionado,
              vereadorComCargo.id,
              presidenteCheckbox,
              viceCheckbox,
              resolve
            );
          });
        } else {
          console.log("‚úÖ Nenhum conflito encontrado");
          // N√£o h√° conflito, limpar qualquer transfer√™ncia pendente
          window.cargoParaTransferir = null;
          return true; // Retorna true para indicar valida√ß√£o OK
        }
      }

      function showCargoConfirmModal(
        message,
        cargoSelecionado,
        vereadorAntigoId,
        presidenteCheckbox,
        viceCheckbox,
        validationCallback
      ) {
        console.log("üö® showCargoConfirmModal chamada com:", {
          message,
          cargoSelecionado,
          vereadorAntigoId,
        });

        const modal = document.getElementById("cargoConfirmModal");
        const messageElement = document.getElementById("cargo-message");
        const confirmBtn = document.getElementById("cargo-confirm-btn");
        const cancelBtn = document.getElementById("cargo-cancel-btn");
        const closeBtn = document.getElementById("cargo-modal-close");

        console.log("üö® Elementos do modal:", {
          modal,
          messageElement,
          confirmBtn,
          cancelBtn,
          closeBtn,
        });

        messageElement.textContent = message;
        modal.classList.add("active");
        document.body.style.overflow = "hidden";

        console.log("üö® Modal deveria estar vis√≠vel agora");

        // Fun√ß√£o para fechar o modal
        const closeModal = () => {
          modal.classList.remove("active");
          document.body.style.overflow = "";
          // Desmarcar o checkbox se cancelou
          if (cargoSelecionado === "presidente") {
            presidenteCheckbox.checked = false;
          } else {
            viceCheckbox.checked = false;
          }
          // Remover event listeners
          confirmBtn.removeEventListener("click", confirmHandler);
          cancelBtn.removeEventListener("click", cancelHandler);
          closeBtn.removeEventListener("click", cancelHandler);
        };

        // Handlers dos bot√µes
        const confirmHandler = () => {
          window.cargoParaTransferir = {
            cargoSelecionado,
            vereadorAntigoId,
          };
          modal.classList.remove("active");
          document.body.style.overflow = "";
          // Toast removido - apenas sucesso ap√≥s salvar
          // Remover event listeners
          confirmBtn.removeEventListener("click", confirmHandler);
          cancelBtn.removeEventListener("click", cancelHandler);
          closeBtn.removeEventListener("click", cancelHandler);

          // Resolver a promise com true (valida√ß√£o OK)
          if (validationCallback) validationCallback(true);
        };

        const cancelHandler = () => {
          closeModal();
          // Resolver a promise com false (valida√ß√£o cancelada)
          if (validationCallback) validationCallback(false);
        };

        // Adicionar event listeners
        confirmBtn.addEventListener("click", confirmHandler);
        cancelBtn.addEventListener("click", cancelHandler);
        closeBtn.addEventListener("click", cancelHandler);
      }

      if (typeof closeModal === "undefined") {
        window.closeModal = function (modalId) {
          const modal = document.getElementById(modalId);
          if (modal) {
            modal.classList.remove("active");
            document.body.style.overflow = "";
          }
        };
      }

      if (typeof openModal === "undefined") {
        window.openModal = function (modalId) {
          const modal = document.getElementById(modalId);
          if (modal) {
            modal.classList.add("active");
            document.body.style.overflow = "hidden";
          }
        };
      }

      async function loadCamaraData(camaraId, token) {
        try {
          const response = await fetch(`/api/camaras/${camaraId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) throw new Error("Falha ao buscar dados da c√¢mara");
          const data = await response.json();

          initLayout({
            title: `Gerenciar: ${data.nome_camara}`,
            icon: "fa-sliders",
          });
          document.getElementById("camara-is_active").checked = data.is_active;
          document.getElementById("nome_camara").value = data.nome_camara || "";
          document.getElementById("municipio").value = data.municipio || "";
          document.getElementById(
            "estado"
          ).innerHTML = `<option value="${data.estado}" selected>${data.estado}</option>`;
          if (data.brasao_url) {
            const preview = document.getElementById("brasao-preview");
            preview.src = data.brasao_url;
            preview.style.display = "block";
            document.querySelector(
              ".background-logo-container"
            ).style.backgroundImage = `url('${data.brasao_url}')`;
          }

          if (data.admin) {
            document.getElementById("admin_email").value = data.admin.email;
            document.getElementById("adminUserId").value = data.admin.id;
          }
          // Preencher campos de TV, se existirem
          if (data.tv && document.getElementById("tv_email")) {
            document.getElementById("tv_email").value = data.tv.email || "";
          }

          document.getElementById("link_facebook").value =
            data.link_facebook || "";
          document.getElementById("link_instagram").value =
            data.link_instagram || "";
          document.getElementById("link_youtube").value =
            data.link_youtube || "";
          document.getElementById("site_oficial").value =
            data.site_oficial || "";
          document.getElementById("youtube_stream_key").value =
            data.youtube_stream_key || "";
          document.getElementById("youtube_rtmp_url").value =
            data.youtube_rtmp_url || "";
          document.getElementById("youtube_channel_id").value =
            data.youtube_channel_id || "";
          document.getElementById("youtube_channel_url").value =
            data.youtube_channel_url || "";
        } catch (error) {
          console.error(error);
          showToast(
            "N√£o foi poss√≠vel carregar as informa√ß√µes da c√¢mara.",
            "error"
          );
        }
      }

      async function loadVereadores(camaraId, token) {
        const grid = document.getElementById("vereadores-grid");
        renderLoadingState(grid, "Carregando vereadores...");
        try {
          const response = await fetch(
            `/api/admin/camaras/${camaraId}/vereadores`,
            { headers: { Authorization: `Bearer ${token}` } }
          );
          if (!response.ok) throw new Error("Falha ao buscar vereadores");
          const data = await response.json();

          // Extrair array de vereadores da resposta
          console.log("üìä Resposta da API de vereadores:", data);
          console.log(
            "üìä Total de vereadores recebidos:",
            data.vereadores?.length || data?.length || 0
          );
          const vereadores = data.vereadores || data || [];

          // Log detalhado de cada vereador
          vereadores.forEach((v, i) => {
            console.log(
              `üìã Vereador ${i + 1}: ${v.nome_parlamentar || v.nome} - Ativo: ${
                v.is_active
              }`
            );
          });

          // Armazenar vereadores globalmente para valida√ß√£o de cargos
          currentVereadores = vereadores;

          if (!vereadores || vereadores.length === 0) {
            renderEmptyState(
              grid,
              "Nenhum vereador cadastrado.",
              "fa-solid fa-users"
            );
            return;
          }

          // Resetar display para grid quando h√° dados
          grid.innerHTML = "";
          grid.style.display = "grid";

          vereadores.forEach((vereador, index) => {
            console.log(`üìã Processando vereador ${index + 1}:`, vereador);

            // Verificar se o vereador tem as propriedades necess√°rias
            const nomeVereador = vereador.nome_parlamentar || vereador.nome;
            if (!vereador || !nomeVereador) {
              console.warn("Vereador com dados incompletos:", vereador);
              return;
            }

            const card = document.createElement("div");
            card.className = "item-card";

            // Compatibilidade com diferentes estruturas de API
            const partidoInfo = vereador.partidos || vereador.partido;
            const partidoNome = partidoInfo
              ? `${partidoInfo.nome} (${partidoInfo.sigla})`
              : "Sem partido";
            let partidoLogoSrc =
              partidoInfo?.logo_url ||
              `https://ui-avatars.com/api/?name=${encodeURIComponent(
                partidoInfo?.sigla || "SP"
              )}&background=161B22&color=fff&size=30`;

            // Gerar flags de cargo
            let cargoFlags = "";
            if (vereador.is_presidente) {
              cargoFlags +=
                '<span class="cargo-flag presidente">Presidente</span>';
            }
            if (vereador.is_vice_presidente) {
              cargoFlags +=
                '<span class="cargo-flag vice-presidente">Vice-Presidente</span>';
            }

            card.innerHTML = `
                    <div class="item-card-header">
                        <img src="${
                          vereador.foto_url ||
                          "https://ui-avatars.com/api/?name=" +
                            encodeURIComponent(nomeVereador) +
                            "&background=random&color=fff"
                        }" alt="Foto de ${nomeVereador}" class="item-card-avatar">
                        <div class="item-card-info">
                            <h4>${nomeVereador.toUpperCase()}</h4>
                            <p style="display: flex; align-items: center; gap: 8px;">
                                <img src="${partidoLogoSrc}" alt="Logo Partido" class="partido-logo-card" onerror="this.src='https://ui-avatars.com/api/?name=P&background=161B22&color=fff&size=30'">
                                ${partidoNome}
                            </p>
                        </div>
                    </div>
                    <div class="item-card-body">
                        <div class="flags-container">
                            <span class="status-badge ${
                              vereador.is_active
                                ? "status-active"
                                : "status-inactive"
                            }">${
              vereador.is_active ? "Ativo" : "Inativo"
            }</span>
                            ${cargoFlags}
                        </div>
                    </div>
                    <div class="item-card-footer">
                        <button class="btn btn-secondary edit-vereador-btn" ${
                          !vereador.is_active
                            ? 'disabled title="N√£o √© poss√≠vel editar vereador inativo"'
                            : ""
                        }>Editar</button>
                        <button class="btn toggle-status-btn" style="background-color: ${
                          vereador.is_active
                            ? "var(--accent-orange)"
                            : "var(--accent-green)"
                        }; color: white;" data-vereador-id="${
              vereador.id
            }" data-active="${vereador.is_active}">
                            ${vereador.is_active ? "Desativar" : "Ativar"}
                        </button>
                        <button class="btn delete-vereador-btn" style="background-color: var(--accent-red); color: white;">Remover</button>
                    </div>`;
            grid.appendChild(card);

            card
              .querySelector(".edit-vereador-btn")
              .addEventListener("click", () => {
                if (!vereador.is_active) {
                  showToast(
                    "N√£o √© poss√≠vel editar vereador inativo. Ative o vereador primeiro.",
                    "error"
                  );
                  return;
                }
                openEditVereadorModal(vereador);
              });
            card
              .querySelector(".delete-vereador-btn")
              .addEventListener("click", () =>
                handleDeleteVereador(vereador.id, camaraId, token)
              );
            card
              .querySelector(".toggle-status-btn")
              .addEventListener("click", (e) =>
                handleToggleActivation(e, camaraId, token)
              );
          });
        } catch (error) {
          console.error(error);
          renderErrorState(grid, "Falha ao carregar vereadores.");
        }
      }

      // Vari√°vel global para o custom select de partidos
      let partidoCustomSelect;

      async function initPartidoCustomSelect(token) {
        try {
          // Verificar se o elemento existe
          const wrapper = document.getElementById("partido-custom-select");
          if (!wrapper) {
            console.error("Elemento partido-custom-select n√£o encontrado");
            return;
          }

          // Inicializar o CustomSelect
          partidoCustomSelect = new CustomSelect({
            wrapperId: "partido-custom-select",
            placeholder: "Selecione um partido...",
          });

          console.log("CustomSelect inicializado:", partidoCustomSelect);

          const response = await fetch("/api/partidos", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) throw new Error("Falha ao buscar partidos");
          const { data } = await response.json();

          // Preparar op√ß√µes para o CustomSelect
          const options = data.map((partido) => ({
            value: partido.id,
            text: `${partido.nome} (${partido.sigla})`,
            image:
              partido.logo_url ||
              `https://ui-avatars.com/api/?name=${encodeURIComponent(
                partido.sigla
              )}&background=161B22&color=fff&size=20`,
            alt: `Logo ${partido.nome}`,
          }));

          partidoCustomSelect.populateOptions(options);
        } catch (error) {
          console.error(error);
          if (partidoCustomSelect) {
            partidoCustomSelect.populateOptions([]);
          }
        }
      }

      function updateBrasaoPreview() {
        const fileInput = document.getElementById("brasao_url");
        const preview = document.getElementById("brasao-preview");
        const backgroundContainer = document.querySelector(
          ".background-logo-container"
        );

        if (fileInput.files && fileInput.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const imageUrl = e.target.result;
            // Atualizar preview da imagem
            preview.src = imageUrl;
            preview.style.display = "block";

            // Atualizar background da logo
            if (backgroundContainer) {
              backgroundContainer.style.backgroundImage = `url('${imageUrl}')`;
            }
          };
          reader.readAsDataURL(fileInput.files[0]);
        }
      }

      function openAddVereadorModal() {
        document.getElementById("vereadorForm").reset();
        document.getElementById("vereadorId").value = "";
        document.getElementById("vereadorModalTitle").textContent =
          "Adicionar Vereador";
        document.getElementById("vereador_email").disabled = false;
        document.getElementById("vereador_email").placeholder =
          "Digite o email do vereador";
        document.getElementById("vereador_senha").required = true;
        document.getElementById("vereador_senha").placeholder =
          "Digite a senha (m√≠nimo 6 caracteres)";
        if (partidoCustomSelect) {
          partidoCustomSelect.reset();
        }
        openModal("vereadorModal");

        // Reconfigurar event listeners ap√≥s abrir modal
        setupCargoToggleLogic();
      }

      function openEditVereadorModal(vereador) {
        document.getElementById("vereadorForm").reset();
        document.getElementById("vereadorId").value = vereador.id;
        document.getElementById("vereadorModalTitle").textContent =
          "Editar Vereador";
        document.getElementById("nome_parlamentar").value =
          vereador.nome_parlamentar;
        // Definir valor no CustomSelect de partidos
        if (partidoCustomSelect && vereador.partidos) {
          partidoCustomSelect.setValue(vereador.partidos.id);
        } else if (partidoCustomSelect) {
          partidoCustomSelect.reset();
        }
        document.getElementById("is_presidente").checked =
          vereador.is_presidente;
        document.getElementById("is_vice_presidente").checked =
          vereador.is_vice_presidente;

        document.getElementById("vereador_email").placeholder =
          "Deixe em branco para n√£o alterar";
        document.getElementById("vereador_email").required = false;

        document.getElementById("vereador_senha").placeholder =
          "Deixe em branco para n√£o alterar";
        document.getElementById("vereador_senha").required = false;

        openModal("vereadorModal");

        // Reconfigurar event listeners ap√≥s abrir modal
        setupCargoToggleLogic();
      }

      async function handleUpdateCamara(event, camaraId, token) {
        event.preventDefault();
        const formId = event.target.id;

        if (formId === "form-info-gerais") {
          // Usar FormData para suportar upload de bras√£o
          const formData = new FormData();
          formData.append(
            "nome_camara",
            document.getElementById("nome_camara").value
          );
          formData.append(
            "municipio",
            document.getElementById("municipio").value
          );
          formData.append("estado", document.getElementById("estado").value);
          formData.append(
            "is_active",
            document.getElementById("camara-is_active").checked
          );

          // Adicionar bras√£o se foi selecionado
          const brasaoInput = document.getElementById("brasao_url");
          if (brasaoInput.files.length > 0) {
            formData.append("brasao", brasaoInput.files[0]);
          }

          try {
            // Adicionar credenciais de TV opcionais ao FormData
            const tvEmailEl = document.getElementById("tv_email");
            const tvSenhaEl = document.getElementById("tv_senha");
            if (tvEmailEl && tvEmailEl.value.trim())
              formData.append("tv_email", tvEmailEl.value.trim());
            if (tvSenhaEl && tvSenhaEl.value)
              formData.append("tv_senha", tvSenhaEl.value);

            const responseCamara = await fetch(`/api/camaras/${camaraId}`, {
              method: "PUT",
              headers: { Authorization: `Bearer ${token}` },
              body: formData,
            });
            if (!responseCamara.ok)
              throw new Error("Falha ao salvar as informa√ß√µes da c√¢mara.");

            // Recarregar dados para mostrar novo bras√£o
            await loadCamaraData(camaraId, token);
          } catch (error) {
            console.error(error);
            showToast(`Erro: ${error.message}`, "error");
            return;
          }
        } else if (formId === "form-midias-sociais") {
          const body = {
            link_facebook: document.getElementById("link_facebook").value,
            link_instagram: document.getElementById("link_instagram").value,
            link_youtube: document.getElementById("link_youtube").value,
            site_oficial: document.getElementById("site_oficial").value,
            youtube_stream_key:
              document.getElementById("youtube_stream_key").value,
            youtube_rtmp_url: document.getElementById("youtube_rtmp_url").value,
            youtube_channel_id:
              document.getElementById("youtube_channel_id").value,
            youtube_channel_url: document.getElementById("youtube_channel_url")
              .value,
          };

          try {
            const responseCamara = await fetch(`/api/camaras/${camaraId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(body),
            });
            if (!responseCamara.ok)
              throw new Error("Falha ao salvar as informa√ß√µes da c√¢mara.");
          } catch (error) {
            console.error(error);
            showToast(`Erro: ${error.message}`, "error");
            return;
          }
        }

        try {
          const newPassword = document.getElementById("admin_senha").value;
          const adminUserId = document.getElementById("adminUserId").value;
          if (newPassword && adminUserId) {
            if (newPassword.length < 6) {
              showToast(
                "A nova senha deve ter no m√≠nimo 6 caracteres.",
                "error"
              );
              return;
            }
            const responseUser = await fetch(`/api/users/${adminUserId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ password: newPassword }),
            });
            if (!responseUser.ok)
              throw new Error("Falha ao atualizar a senha do administrador.");
            document.getElementById("admin_senha").value = "";
          }
          showToast("Informa√ß√µes salvas com sucesso!", "success");
        } catch (error) {
          console.error(error);
          showToast(`Erro: ${error.message}`, "error");
        }
      }

      // FUN√á√ÉO 'handleVereadorFormSubmit' ATUALIZADA COM AS VALIDA√á√ïES
      async function handleVereadorFormSubmit(e, camaraId, token) {
        e.preventDefault();

        // ‚úÖ PRIMEIRA VALIDA√á√ÉO: Verificar conflitos de cargo ANTES de processar
        const validationResult = await validateCargoUnico();
        if (validationResult !== true) {
          console.log("‚ùå Valida√ß√£o de cargo falhou ou foi cancelada");
          return; // Para aqui se a valida√ß√£o falhar ou for cancelada
        }

        console.log(
          "‚úÖ Valida√ß√£o de cargo aprovada, continuando com o salvamento..."
        );

        const id = document.getElementById("vereadorId").value;
        const isEditing = !!id;

        const body = {
          nome_parlamentar: document.getElementById("nome_parlamentar").value,
          partido_id: document.getElementById("partido_id").value,
          is_presidente: document.getElementById("is_presidente").checked,
          is_vice_presidente:
            document.getElementById("is_vice_presidente").checked,
        };

        if (isEditing) {
          const emailInput = document.getElementById("vereador_email");
          const senhaInput = document.getElementById("vereador_senha");
          const newEmail = emailInput.value;
          const newSenha = senhaInput.value;

          // Valida o email apenas se um novo valor for inserido
          if (newEmail) {
            if (!formValidator.validateField("vereador_email", newEmail)) {
              return; // Interrompe se o email for inv√°lido
            }
            body.email = newEmail;
          }

          // Valida a senha apenas se uma nova senha for inserida
          if (newSenha) {
            if (!formValidator.validateField("vereador_senha", newSenha)) {
              return; // Interrompe se a senha for fraca
            }
            body.senha = newSenha;
          }
        } else {
          // L√≥gica de cria√ß√£o (que j√° possui valida√ß√£o adequada)
          body.email = document.getElementById("vereador_email").value;
          body.senha = document.getElementById("vereador_senha").value;
          if (body.senha && body.senha.length < 6) {
            showToast("A senha deve ter no m√≠nimo 6 caracteres.", "error");
            return;
          }
        }

        // Usar FormData para suportar upload de foto
        const formData = new FormData();
        Object.keys(body).forEach((key) => {
          formData.append(key, body[key]);
        });

        // Adicionar foto se foi selecionada
        const fotoInput = document.getElementById("foto_url_vereador");
        if (fotoInput.files.length > 0) {
          formData.append("foto_url_vereador", fotoInput.files[0]);
        }

        const url = isEditing
          ? `/api/vereadores/${id}`
          : `/api/camaras/${camaraId}/vereadores`;
        const method = isEditing ? "PUT" : "POST";

        try {
          // Processar transfer√™ncia de cargo se necess√°rio
          if (window.cargoParaTransferir) {
            const { cargoSelecionado, vereadorAntigoId } =
              window.cargoParaTransferir;

            // Remover cargo do vereador anterior
            const updateAntigoBody = {};
            updateAntigoBody[`is_${cargoSelecionado}`] = false;

            await fetch(`/api/vereadores/${vereadorAntigoId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(updateAntigoBody),
            });

            // Limpar a transfer√™ncia ap√≥s processamento
            window.cargoParaTransferir = null;
          }
          const response = await fetch(url, {
            method,
            headers: { Authorization: `Bearer ${token}` },
            body: formData,
          });
          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.details || "Falha ao salvar.");
          }

          const vereadorNome =
            document.getElementById("nome_parlamentar").value;
          const isEditing = !!document.getElementById("vereadorId").value;
          showToast(
            `Vereador ${vereadorNome} ${
              isEditing ? "atualizado" : "adicionado"
            } com sucesso!`,
            "success"
          );

          closeModal("vereadorModal");
          await loadVereadores(camaraId, token);
        } catch (error) {
          showToast(`Erro: ${error.message}`, "error");
        }
      }

      function showDeleteVereadorModal(
        vereadorId,
        vereadorNome,
        camaraId,
        token
      ) {
        const modal = document.getElementById("deleteVereadorModal");
        const messageElement = document.getElementById("delete-message");
        const confirmBtn = document.getElementById("delete-confirm-btn");
        const cancelBtn = document.getElementById("delete-cancel-btn");
        const closeBtn = document.getElementById("delete-modal-close");

        const message = `Tem certeza que deseja remover o vereador "${vereadorNome}"?\n\nEsta a√ß√£o ir√° remover permanentemente:\n‚Ä¢ Registro do vereador\n‚Ä¢ Perfil de usu√°rio\n‚Ä¢ Acesso de login\n\nEsta a√ß√£o n√£o pode ser desfeita.`;

        messageElement.textContent = message;
        modal.classList.add("active");
        document.body.style.overflow = "hidden";

        const closeModal = () => {
          modal.classList.remove("active");
          document.body.style.overflow = "";
          confirmBtn.removeEventListener("click", confirmHandler);
          cancelBtn.removeEventListener("click", cancelHandler);
          closeBtn.removeEventListener("click", cancelHandler);
        };

        const confirmHandler = async () => {
          closeModal();
          await executeDeleteVereador(vereadorId, camaraId, token);
        };

        const cancelHandler = closeModal;

        confirmBtn.addEventListener("click", confirmHandler);
        cancelBtn.addEventListener("click", cancelHandler);
        closeBtn.addEventListener("click", cancelHandler);
      }

      async function executeDeleteVereador(vereadorId, camaraId, token) {
        try {
          const response = await fetch(`/api/vereadores/${vereadorId}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.details || "Falha ao remover.");
          }

          showToast("Vereador removido com sucesso!", "success");
          await loadVereadores(camaraId, token);
        } catch (error) {
          showToast(`Erro: ${error.message}`, "error");
        }
      }

      async function handleDeleteVereador(vereadorId, camaraId, token) {
        // Buscar nome do vereador primeiro
        const vereador = currentVereadores.find((v) => v.id === vereadorId);
        const vereadorNome = vereador ? vereador.nome_parlamentar : "vereador";

        showDeleteVereadorModal(vereadorId, vereadorNome, camaraId, token);
      }

      async function handleToggleActivation(event, camaraId, token) {
        const button = event.currentTarget;
        const vereadorId = button.dataset.vereadorId;
        const currentStatus = button.dataset.active === "true";

        const confirmou = await showConfirmModal(
          `O vereador ${
            currentStatus
              ? "n√£o poder√° mais acessar o sistema"
              : "voltar√° a ter acesso ao sistema"
          }.`,
          `${currentStatus ? "Desativar" : "Reativar"} acesso?`
        );
        if (!confirmou) return;

        try {
          const response = await fetch(`/api/vereadores/${vereadorId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ is_active: !currentStatus }),
          });
          if (!response.ok) throw new Error("Falha ao atualizar status.");

          showToast(
            `Vereador ${currentStatus ? "desativado" : "ativado"} com sucesso!`,
            "success"
          );
          await loadVereadores(camaraId, token);
        } catch (error) {
          showToast(`Erro: ${error.message}`, "error");
        }
      }
    </script>
  </body>
</html>
