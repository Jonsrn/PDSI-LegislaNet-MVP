<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TV - Vota√ß√£o</title>

    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì∫</text></svg>"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/css/global.css" />
    <link rel="stylesheet" href="/css/portal.css" />

    <style>
      /* ESTILOS ESPEC√çFICOS DA TV BASEADOS NO TEMPLATE P√öBLICO */

      body {
        font-family: Inter, system-ui, sans-serif;
        background: var(--background-dark);
        color: var(--primary-text);
        margin: 0;
        padding: 0;
      }

      /* Layout da TV - Vers√£o Adaptada do P√∫blico */
      .tv-layout {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 20px;
        flex-grow: 1;
        max-width: 90vw; /* Ocupar 90% da largura da tela */
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
      }

      .info-column,
      .votantes-column {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* Cards de Informa√ß√£o - Igual ao P√∫blico */
      .info-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
      }

      .info-card h3 {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--secondary-text);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .info-card p,
      .info-card a {
        font-size: 1.1rem; /* Ligeiramente maior para TV */
        color: var(--primary-text);
        line-height: 1.5;
        margin: 0 0 8px 0;
      }

      .info-card a {
        color: var(--accent-blue);
        text-decoration: none;
        font-weight: 500;
      }

      .info-card a:hover {
        text-decoration: underline;
      }

      /* T√≠tulo da Pauta - Maior para TV */
      .pauta-title {
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--primary-text);
        margin-bottom: 12px;
        line-height: 1.2;
      }

      /* Badge de Vota√ß√£o Simb√≥lica */
      .badge-simbolica {
        background-color: rgba(218, 54, 51, 0.2);
        color: #f85149;
        border: 1px solid rgba(218, 54, 51, 0.4);
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 10;
      }

      /* Estat√≠sticas de Vota√ß√£o - MENOR que no p√∫blico */
      .stats-card {
        background: linear-gradient(
          135deg,
          var(--card-bg) 0%,
          var(--background-light) 100%
        );
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 18px; /* Reduzido de 24px */
        position: relative;
        overflow: hidden;
      }

      .stats-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px; /* Reduzido de 20px */
      }

      .stats-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1.1rem; /* Reduzido de 1.2rem */
        font-weight: 600;
        color: var(--primary-text);
      }

      .live-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.75rem; /* Reduzido de 0.8rem */
        font-weight: 600;
        color: var(--accent-blue);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .live-dot {
        width: 8px;
        height: 8px;
        background-color: var(--accent-blue);
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      .vote-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px; /* Reduzido de 16px */
        margin-bottom: 16px; /* Reduzido de 20px */
      }

      .stat-item {
        text-align: center;
        padding: 16px 12px; /* Reduzido de 20px 16px */
        border-radius: 10px;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .stat-item::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        border-radius: 10px 10px 0 0;
        transition: all 0.3s ease;
      }

      .stat-item.favor {
        background-color: rgba(46, 160, 67, 0.1);
        border-color: rgba(46, 160, 67, 0.3);
      }

      .stat-item.favor::before {
        background-color: var(--accent-green);
      }

      .stat-item.against {
        background-color: rgba(248, 81, 73, 0.1);
        border-color: rgba(248, 81, 73, 0.3);
      }

      .stat-item.against::before {
        background-color: var(--accent-red);
      }

      .stat-item.abstention {
        background-color: rgba(212, 175, 55, 0.1);
        border-color: rgba(212, 175, 55, 0.3);
      }

      .stat-item.abstention::before {
        background-color: var(--accent-gold);
      }

      .stat-number {
        font-size: 2.2rem; /* Reduzido de 2.5rem */
        font-weight: 700;
        display: block;
        line-height: 1;
        margin-bottom: 6px; /* Reduzido de 8px */
      }

      .stat-item.favor .stat-number {
        color: var(--accent-green);
      }
      .stat-item.against .stat-number {
        color: var(--accent-red);
      }
      .stat-item.abstention .stat-number {
        color: var(--accent-gold);
      }

      .stat-label {
        font-size: 0.85rem; /* Reduzido de 0.9rem */
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--secondary-text);
      }

      .stat-icon {
        font-size: 1.1rem; /* Reduzido de 1.2rem */
        margin-bottom: 6px; /* Reduzido de 8px */
        display: block;
      }

      .stat-item.favor .stat-icon {
        color: var(--accent-green);
      }
      .stat-item.against .stat-icon {
        color: var(--accent-red);
      }
      .stat-item.abstention .stat-icon {
        color: var(--accent-gold);
      }

      .total-votes {
        text-align: center;
        padding: 14px; /* Reduzido de 16px */
        background-color: transparent; /* Removido fundo preto */
        border-radius: 8px;
        border: 1px solid var(--border-color);
      }

      .total-votes .number {
        font-size: 1.3rem; /* Reduzido de 1.5rem */
        font-weight: 700;
        color: var(--accent-blue);
        display: block;
      }

      .total-votes .label {
        font-size: 0.8rem; /* Reduzido de 0.9rem */
        color: var(--secondary-text);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Grid de Votantes - Aumentado para TV */
      .votantes-grid {
        display: grid;
        grid-template-columns: repeat(
          auto-fill,
          minmax(320px, 1fr)
        ); /* Aumentado de 280px */
        gap: 20px; /* Aumentado de 16px */
      }

      .votante-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px; /* Aumentado de 16px */
        display: flex;
        flex-direction: column;
        gap: 14px; /* Aumentado de 12px */
        transition: all 0.2s ease;
      }

      .votante-card:hover {
        border-color: var(--accent-blue);
        transform: translateY(-2px);
      }

      .votante-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        min-height: 40px;
      }

      .votante-info {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        flex: 1;
      }

      .votante-avatar {
        width: 65px; /* Aumentado de 50px */
        height: 65px; /* Aumentado de 50px */
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
        border: 2px solid var(--accent-blue);
      }

      .votante-detalhes {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 1;
        min-width: 0;
      }

      .votante-name {
        font-weight: 600;
        color: var(--primary-text);
        word-wrap: break-word;
        overflow-wrap: break-word;
        line-height: 1.2;
      }

      .partido-info {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .partido-logo {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        object-fit: contain;
        background-color: rgba(255, 255, 255, 0.1);
        padding: 2px;
      }

      .partido-sigla {
        font-size: 0.75rem;
        color: var(--secondary-text);
        font-weight: 500;
        padding: 2px 6px;
        background-color: rgba(88, 166, 255, 0.1);
        border-radius: 4px;
        border: 1px solid rgba(88, 166, 255, 0.3);
      }

      .tag {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 99px;
        flex-shrink: 0;
        align-self: flex-start;
      }

      .tag-presidente {
        background-color: rgba(240, 136, 51, 0.2);
        color: var(--accent-orange);
        border: 1px solid rgba(240, 136, 51, 0.3);
      }

      .voto-display {
        padding: 10px;
        border-radius: 6px;
        text-align: center;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        color: white;
        font-size: 0.9rem;
      }

      .voto-sim {
        background-color: var(--accent-green);
      }
      .voto-nao {
        background-color: var(--accent-red);
      }
      .voto-abstencao {
        background-color: var(--accent-orange);
      }

      .votante-timestamp {
        font-size: 0.75rem;
        color: var(--secondary-text);
        text-align: center;
        margin-top: 4px;
      }

      /* Status de Conex√£o - Igual ao template de espera */
      .connection-status {
        position: fixed;
        top: 12px;
        right: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        background: #5cb85c;
        padding: 8px 12px;
        border-radius: 20px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        animation: breathe 2s ease-in-out infinite;
      }

      .connection-status.status-disconnected {
        background: #d9534f;
      }

      /* Anima√ß√£o de respiro para os badges */
      @keyframes breathe {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .badge-simbolica {
        animation: breathe 2s ease-in-out infinite;
      }

      .reconnect-btn {
        padding: 6px 12px;
        background: var(--accent-blue);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        margin-left: 8px;
      }

      .reconnect-btn:hover {
        background: var(--accent-blue-hover);
      }

      /* Anima√ß√µes */
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      /* Responsividade para TVs grandes */
      @media (min-width: 1800px) {
        .pauta-title {
          font-size: 2.8rem;
        }
        .stat-number {
          font-size: 2.8rem;
        }
        .info-card p {
          font-size: 1.2rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Status de Conex√£o -->
    <div class="connection-status" id="connectionStatus">
      <span id="statusText">Conectado</span>
      <button class="reconnect-btn" id="reconnectBtn" style="display: none">
        Reconectar
      </button>
    </div>

    <div class="tv-layout">
      <!-- Coluna de Informa√ß√µes -->
      <div class="info-column">
        <!-- Informa√ß√µes da Pauta -->
        <div class="info-card" style="position: relative">
          <div
            class="badge-simbolica"
            id="badgeSimbolica"
            style="display: none"
          >
            Vota√ß√£o Simb√≥lica
          </div>
          <h3 id="pautaTitleLabel">Pauta em Vota√ß√£o</h3>
          <div class="pauta-title" id="pautaTitle">Carregando pauta...</div>
        </div>

        <!-- Descri√ß√£o da Pauta -->
        <div class="info-card">
          <h3>Descri√ß√£o da Pauta</h3>
          <p id="pautaDescricao">Carregando descri√ß√£o...</p>
        </div>

        <!-- Estat√≠sticas de Vota√ß√£o -->
        <div class="stats-card">
          <div class="stats-header">
            <div class="stats-title">
              <i class="fas fa-chart-bar"></i>
              Resultado da Vota√ß√£o
            </div>
            <div class="live-indicator">
              <div class="live-dot"></div>
              Ao Vivo
            </div>
          </div>

          <div class="vote-stats">
            <div class="stat-item favor">
              <i class="fas fa-check-circle stat-icon"></i>
              <span class="stat-number" id="simCount">0</span>
              <div class="stat-label">Favor√°veis</div>
            </div>
            <div class="stat-item against">
              <i class="fas fa-times-circle stat-icon"></i>
              <span class="stat-number" id="naoCount">0</span>
              <div class="stat-label">Contr√°rios</div>
            </div>
            <div class="stat-item abstention">
              <i class="fas fa-hand stat-icon"></i>
              <span class="stat-number" id="absCount">0</span>
              <div class="stat-label">Absten√ß√µes</div>
            </div>
          </div>

          <div class="total-votes">
            <span class="number" id="totalVotes">0</span>
            <div class="label">Total de Votos</div>
          </div>
        </div>
      </div>

      <!-- Coluna de Votantes -->
      <div class="votantes-column">
        <h3
          style="
            color: var(--secondary-text);
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          "
        >
          Votos Registrados
        </h3>
        <div class="votantes-grid" id="votantes">
          <!-- Cards de votantes ser√£o inseridos aqui -->
        </div>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="../js/global.js"></script>

    <script>
      let tvSocket = null;
      let camaraId = null;

      // Fun√ß√£o para garantir carregamento do Socket.IO
      async function ensureSocketClient() {
        if (typeof io === "undefined") {
          await new Promise((resolve, reject) => {
            const s = document.createElement("script");
            s.src = "https://cdn.socket.io/4.6.1/socket.io.min.js";
            s.onload = resolve;
            s.onerror = () => reject(new Error("Falha ao carregar Socket.IO"));
            document.head.appendChild(s);
          });
        }
      }

      // Par√¢metros e elementos DOM
      const token = localStorage.getItem("authToken");
      const params = new URLSearchParams(window.location.search);
      const pautaId = params.get("pauta");

      const connectionStatus = document.getElementById("connectionStatus");
      const statusText = document.getElementById("statusText");
      const reconnectBtn = document.getElementById("reconnectBtn");

      const pautaTitle = document.getElementById("pautaTitle");
      const pautaDescricao = document.getElementById("pautaDescricao");
      const badgeSimbolica = document.getElementById("badgeSimbolica");

      const simEl = document.getElementById("simCount");
      const naoEl = document.getElementById("naoCount");
      const absEl = document.getElementById("absCount");
      const totalVotesEl = document.getElementById("totalVotes");
      const votantesEl = document.getElementById("votantes");

      function renderVotante(v) {
        const card = document.createElement("div");
        card.className = "votante-card";
        card.dataset.votoId = v.id || "";

        const vereador = v.vereadores;
        const partido = vereador?.partidos;
        const timestamp = new Date(v.created_at).toLocaleString("pt-BR");
        const votoClass = getVotoClass(v.voto);
        const votoIcon = getVotoIcon(v.voto);
        const presidenteTag = v.era_presidente_no_voto
          ? '<span class="tag tag-presidente">Presidente</span>'
          : "";

        // Avatar do vereador
        const avatarUrl =
          vereador?.foto_url ||
          `https://ui-avatars.com/api/?name=${encodeURIComponent(
            vereador?.nome_parlamentar || "N"
          )}`;

        // Informa√ß√µes do partido
        const partidoInfo = partido
          ? `
            <div class="partido-info">
                ${
                  partido.logo_url
                    ? `<img src="${partido.logo_url}" alt="${partido.sigla}" class="partido-logo" onerror="this.style.display='none'">`
                    : ""
                }
                <span class="partido-sigla">${escapeHtml(
                  partido.sigla || "S/P"
                )}</span>
            </div>
        `
          : '<div class="partido-info"><span class="partido-sigla">S/P</span></div>';

        card.innerHTML = `
            <div class="votante-header">
                <div class="votante-info">
                    <img src="${avatarUrl}" alt="Avatar" class="votante-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(
          vereador?.nome_parlamentar || "N"
        )}'">
                    <div class="votante-detalhes">
                        <span class="votante-name">${escapeHtml(
                          vereador?.nome_parlamentar || "Vereador"
                        )}</span>
                        ${partidoInfo}
                    </div>
                </div>
                ${presidenteTag}
            </div>
            <div class="votante-timestamp">Votou em: ${timestamp}</div>
            <div class="voto-display ${votoClass}">${votoIcon} ${v.voto}</div>
        `;

        return card;
      }

      // üì∫ FUN√á√ÉO PARA MOSTRAR NOTIFICA√á√ÉO DE VOTO NA TV
      function getVotoClass(voto) {
        switch (voto) {
          case "SIM":
            return "voto-sim";
          case "N√ÉO":
            return "voto-nao";
          case "ABSTEN√á√ÉO":
            return "voto-abstencao";
          default:
            return "";
        }
      }

      function getVotoIcon(voto) {
        switch (voto) {
          case "SIM":
            return '<i class="fa-regular fa-circle-check"></i>';
          case "N√ÉO":
            return '<i class="fa-regular fa-circle-xmark"></i>';
          case "ABSTEN√á√ÉO":
            return '<i class="fas fa-hand"></i>';
          default:
            return "";
        }
      }

      function escapeHtml(text = "") {
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
      function showVoteNotification(vereadorNome, voto, isUpdate) {
        // Criar container de notifica√ß√£o se n√£o existir
        let notificationContainer = document.getElementById(
          "tv-notification-container"
        );
        if (!notificationContainer) {
          notificationContainer = document.createElement("div");
          notificationContainer.id = "tv-notification-container";
          notificationContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
          `;
          document.body.appendChild(notificationContainer);
        }

        // Determinar cor do voto
        let bgColor, icon;
        switch (voto) {
          case "SIM":
            bgColor = "#2ea043";
            icon = "‚úÖ";
            break;
          case "N√ÉO":
            bgColor = "#da3633";
            icon = "‚ùå";
            break;
          case "ABSTEN√á√ÉO":
            bgColor = "#f08833";
            icon = "ü§ö";
            break;
          default:
            bgColor = "#58a6ff";
            icon = "üó≥Ô∏è";
        }

        // Criar notifica√ß√£o
        const notification = document.createElement("div");
        notification.style.cssText = `
          background: ${bgColor};
          color: white;
          padding: 16px 20px;
          border-radius: 12px;
          box-shadow: 0 8px 24px rgba(0,0,0,0.3);
          font-weight: 600;
          font-size: 1.4rem;
          max-width: 400px;
          animation: slideInFromRight 0.3s ease-out;
        `;

        const updateText = isUpdate ? " (alterou voto)" : "";
        notification.innerHTML = `
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 1.6rem;">${icon}</span>
            <div>
              <div style="font-size: 1.2rem; margin-bottom: 4px;">${vereadorNome}</div>
              <div style="font-size: 1.4rem; font-weight: 700;">Votou: ${voto}${updateText}</div>
            </div>
          </div>
        `;

        // Adicionar estilos de anima√ß√£o se n√£o existirem
        if (!document.getElementById("tv-notification-animations")) {
          const style = document.createElement("style");
          style.id = "tv-notification-animations";
          style.textContent = `
            @keyframes slideInFromRight {
              from { transform: translateX(100%); opacity: 0; }
              to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutToRight {
              from { transform: translateX(0); opacity: 1; }
              to { transform: translateX(100%); opacity: 0; }
            }
          `;
          document.head.appendChild(style);
        }

        // Adicionar √† container
        notificationContainer.appendChild(notification);

        // Remover automaticamente ap√≥s 4 segundos
        setTimeout(() => {
          if (notification.parentNode) {
            notification.style.animation = "slideOutToRight 0.3s ease-in";
            setTimeout(() => {
              if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
              }
            }, 300);
          }
        }, 4000);
      }

      // Fun√ß√£o para carregar dados iniciais e atualizar interface
      async function fetchInitial() {
        try {
          const resp = await fetch(`/api/votos/pauta/${pautaId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!resp.ok) return;
          const data = await resp.json();

          // Armazenar camaraId para uso no WebSocket
          camaraId = data.pauta?.sessoes?.camara_id;

          // Atualizar informa√ß√µes da pauta
          const pautaData = data.pauta;
          console.log("üìã Dados da pauta (fetchInitial):", pautaData);

          // Verificar se √© vota√ß√£o simb√≥lica e n√£o mostrar no t√≠tulo
          let pautaNome = pautaData?.nome || "Pauta sem nome";
          if (pautaNome.toLowerCase().includes("vota√ß√£o simb√≥lica")) {
            // Remove "Vota√ß√£o Simb√≥lica" do t√≠tulo e mostra o badge
            pautaNome = pautaNome.replace(/vota√ß√£o simb√≥lica/gi, "").trim();
            badgeSimbolica.style.display = "block";
          } else if (pautaData?.votacao_simbolica) {
            // Se tem flag votacao_simbolica, mostra o badge
            badgeSimbolica.style.display = "block";
          } else {
            badgeSimbolica.style.display = "none";
          }

          pautaTitle.textContent = pautaNome;
          const descricao = pautaData?.descricao || "Sem descri√ß√£o dispon√≠vel";
          pautaDescricao.textContent = descricao;
          console.log("üìù Descri√ß√£o atualizada (fetchInitial):", descricao); // Atualizar estat√≠sticas
          updateStats(data.estatisticas);

          // Renderizar votantes
          votantesEl.innerHTML = "";
          (data.votos || []).forEach((v) =>
            votantesEl.appendChild(renderVotante(v))
          );
        } catch (err) {
          console.error("Erro fetchInitial", err);
        }
      }

      // Fun√ß√£o para atualizar estat√≠sticas
      function updateStats(stats) {
        const sim = stats?.sim || 0;
        const nao = stats?.nao || 0;
        const abstencao = stats?.abstencao || 0;
        const total = sim + nao + abstencao;

        simEl.textContent = sim;
        naoEl.textContent = nao;
        absEl.textContent = abstencao;
        totalVotesEl.textContent = total;
      }

      (async () => {
        try {
          // Primeiro carregar dados para obter camaraId
          await fetchInitial();

          await ensureSocketClient();
          tvSocket = io("http://localhost:3000", { auth: { token } });
          tvSocket.on("connect", () => {
            console.log("TV conectado ao socket");
            statusText.textContent = "Conectado";
            connectionStatus.style.background = "#5cb85c";
            connectionStatus.classList.remove("status-disconnected");
            reconnectBtn.style.display = "none";

            // Conectar √† sala da pauta E da c√¢mara
            tvSocket.emit("tv:join-pauta", { pautaId });
            if (camaraId) {
              tvSocket.emit("tv:join-camara", { camaraId });
              console.log(
                `üì∫ TV conectada √† c√¢mara ${camaraId} e pauta ${pautaId}`
              );
            }
          });

          tvSocket.on("disconnect", () => {
            statusText.textContent = "Desconectado";
            connectionStatus.style.background = "#d9534f";
            connectionStatus.classList.add("status-disconnected");
            reconnectBtn.style.display = "inline-block";
          });

          tvSocket.on("votacao-ao-vivo-update", (data) => {
            if (
              data.pautaId &&
              data.pautaId.toString() === pautaId.toString()
            ) {
              if (data.totals) {
                updateStats(data.totals);
              }
              if (data.voto) {
                const existing = votantesEl.querySelector(
                  `[data-voto-id="${data.voto.id}"]`
                );
                if (existing) existing.remove();
                votantesEl.prepend(renderVotante(data.voto));
              }
            }
          });

          // üì∫ LISTENER PARA INICIO DE VOTA√á√ÉO COM DADOS DA PAUTA
          tvSocket.on("tv:iniciar-votacao", (data) => {
            console.log("üì∫ Iniciando vota√ß√£o na TV:", data);

            if (data.pauta) {
              // Atualizar todas as informa√ß√µes da pauta recebidas
              const pautaData = data.pauta;
              console.log("üìã Dados da pauta recebidos:", pautaData);

              // Verificar vota√ß√£o simb√≥lica
              let pautaNome = pautaData.nome || "Pauta sem nome";
              if (pautaNome.toLowerCase().includes("vota√ß√£o simb√≥lica")) {
                pautaNome = pautaNome.replace(/vota√ß√£o simb√≥lica/gi, "").trim();
                badgeSimbolica.style.display = "block";
              } else if (pautaData.votacao_simbolica) {
                badgeSimbolica.style.display = "block";
              } else {
                badgeSimbolica.style.display = "none";
              }

              pautaTitle.textContent = pautaNome;
              const descricao =
                pautaData.descricao || "Sem descri√ß√£o dispon√≠vel";
              pautaDescricao.textContent = descricao;
              console.log("üìù Descri√ß√£o atualizada:", descricao);

              document.getElementById("pautaTitleLabel").textContent =
                "Pauta em Vota√ß√£o";
            } else {
              console.log("‚ùå Nenhum dado de pauta recebido");
            }
          });

          // üì∫ LISTENER PARA NOTIFICA√á√ïES DE VOTOS DOS TABLETS
          tvSocket.on("tv:voto-notification", (data) => {
            console.log("üó≥Ô∏è Voto recebido na TV:", data);

            if (
              data.pautaId &&
              data.pautaId.toString() === pautaId.toString()
            ) {
              // Mostrar notifica√ß√£o visual na TV
              showVoteNotification(data.vereadorNome, data.voto, data.isUpdate);

              // Atualizar dados se necess√°rio (recarregar estat√≠sticas)
              setTimeout(() => {
                fetchInitial();
              }, 1000);
            }
          });

          tvSocket.on("votacao-finalizada", (data) => {
            console.log("üèÅ Vota√ß√£o finalizada recebida na TV:", data);
            if (
              data.pautaId &&
              data.pautaId.toString() === pautaId.toString()
            ) {
              console.log("‚úÖ Pauta corresponde, finalizando vota√ß√£o...");
              document.getElementById("pautaTitleLabel").textContent =
                "Vota√ß√£o Finalizada";

              // Redirecionar para a p√°gina de espera ap√≥s 3 segundos
              console.log("‚è±Ô∏è Redirecionando para espera em 3 segundos...");
              setTimeout(() => {
                console.log("üîÑ Redirecionando para /tv/espera.html");
                window.location.href = "/tv/espera.html";
              }, 3000);
            } else {
              console.log(
                "‚ùå Pauta n√£o corresponde - Recebida:",
                data.pautaId,
                "Esperada:",
                pautaId
              );
            }
          });

          // üì∫ LISTENER PARA ENCERRAMENTO DE VOTA√á√ÉO
          tvSocket.on("tv:encerrar-votacao", (data) => {
            console.log("ÔøΩ Encerrando vota√ß√£o na TV (evento direto):", data);

            // Redirecionar imediatamente para a p√°gina de espera
            console.log("üîÑ Redirecionando imediatamente para /tv/espera.html");
            window.location.href = "/tv/espera.html";
          });

          tvSocket.on("connect_error", (err) => {
            console.error("Erro de conex√£o socket:", err);
          });

          reconnectBtn.addEventListener("click", () => {
            if (tvSocket) tvSocket.connect();
            else window.location.reload();
          });
        } catch (error) {
          console.error("Erro na inicializa√ß√£o:", error);
          statusText.textContent = "Erro de inicializa√ß√£o";
        }
      })();
    </script>
  </body>
</html>
